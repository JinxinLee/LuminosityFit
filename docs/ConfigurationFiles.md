Everything that's needed for a _complete_ simulation-reconstruction-lumiFit run is in the config directory. The files are:

- [dataconfig\_xy.json](#dataconfig_xyjson)
- [fitconfig-fast.json](#fitconfig-fastjson)
  - [estimator\_type](#estimator_type)
  - [estimator\_options](#estimator_options)
  - [fit\_model\_options](#fit_model_options)
  - [free\_parameter\_names](#free_parameter_names)
- [offset\_trafo\_matrix.json](#offset_trafo_matrixjson)
- [vertex\_fitconfig.json](#vertex_fitconfigjson)

## dataconfig_xy.json

The Lumi Fit Software needs to created a refined set of data from the "raw" `Lumi_TrksQA.root` files. This is done by the script [scripts/createMultipleLmdData.md](createMultipleLmdData.py), which in turn needs the `dataconfig_xy.json` file. It contains information on how the binning is done, what minimum and maximum acceptances are and so forth.

The user shouldn't need to change any of the parameters in this file (some of them are even hard codes elsewhere, so beware).

## fitconfig-fast.json

This file looks deceivingly short, but it is _the_ central configuration file for the Lumi Fit Software. It is only read by the `lumiFit` executable, as the last step of the entire reco/fit chain.

Many of the parameters in this file are foot guns, so I'll try to explain them here.

### estimator_type

Can either be:

- LOG_LIKELIHOOD
- CHI2

The former is the default, and the one that should be used. If you run into stability issues, you can try the latter.

### estimator_options

These values depend on the detector geometry and are in projected px/pz or py/pz space. Because the elastic part of the integral diverges at the center, the estimator needs to be cut off at some point.

### fit_model_options

These are by far the most impactful parameters to tune the fit. They are:

| Parameter                                          | Default        | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -------------------------------------------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **"fit_dimension"**                                | **2**          | (int) can either be 1 or 2, but most of the 1-dimensional stuff is not even working anymore. So just leave it at 2.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **"dpm_elastic_parts"**                            | **"ALL"**      | (string) should always be "ALL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **"theta_t_trafo_option"**                         | **"APPROX"**   | (string) can be "APPROX" or "CORRECT". I've only ever used "APPROX", no idea if "CORRECT" even works.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **"divergence_smearing_active"**                   | **false**      | (bool) beam divergence leads to a "smeared" acceptance. Compensating for that (true) works, but is a little less accurate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"fix_beam_divs"**                                | **true**       | (bool) if true, the beam divergence is fixed to the values given in the next two parameters, if false, they remain free parameters in the fit. fixing usually leads to a more precise fit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **"beam_div_x"**                                   | **0.0001**     | see above                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"beam_div_y"**                                   | **0.0001**     | see above                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"elastic_data_input_directory"**                 | **""**         | I'm surprised this is even here. It can be empty, it's not used from here.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **"fix_beam_tilts"**                               | **true**       | (bool) if true, the beam tilts are fixed to the values given in the next two parameters, if false, they remain free parameters in the fit. fixing usually leads to a more precise fit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **"beam_tilt_x"**                                  | **0.0**        | see above                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"beam_tilt_y"**                                  | **0.0**        | see above                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"fix_ip_offsets"**                               | **true**       | (bool) if true, the IP offsets are fixed to whatever is in the "reco_ip.josn" file that was created earlier [WHERE](WHERE?) in the run. if false, they remain free parameters in the fit. This must be always FIXED as far as I understand, because the fit doesn't converge otherwise.                                                                                                                                                                                                                                                                                                                                                                                         |
| **"acceptance_correction_active"**                 | **true**       | (bool) if true, the acceptance correction is applied, if false, it is not                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| **"acceptance_interpolation"**                     | **"CONSTANT"** | (string) can be "CONSTANT", "LINEAR" or "SPLINE". I've only ever used "CONSTANT", that one works fine, so why change it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| **"automatic_acceptance_boundary_finding_active"** | **true**       | (bool) if true, the acceptance boundaries are attempted to be found automatically, otherwise they are hard coded to something like 0.0013. Since there shouldn't be any more secondaries in the res/acc data, this should work quite reliably.                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| **"automatic_acceptance_shifting_active"**         | **false**      | (bool) **This is a dangerous foot gun!** If the IP was offset, the `determineLuminosity.py` script gives the fitted IP (via `reco_ip.json`) to the `lumiFit` executable, which then shifts the acceptance directly according to the IP (see [offset_trafo_matrix.json](#offset_trafo_matrixjson) for details). The automatic shift finding attempts to do this again and usually makes everything worse. So unless you want to explicitly run a scenario where the IP is shifted but we have no way of knowing that (and the auto fitter for the IP also fails), always leave this at false. |
| **"clean_lower_acceptance"**                       | **false**      | (bool) in the center of the acceptance, there is a pretty cleanly cut ten-edged hole. Because there are no more sensors there. Sometimes however, a secondary particle still ended up in the hole. That royally fucked up the fit all proper like, so we introduced an attempt to find this edge automatically, approximate it with a circle and discard everything in that circle. That worked quite okay-ish, but now we simply cut all secondary particles and the center remains free from secondaries. So this can remain **false**.                                                                                                                                       |
| **"acceptance_bound_low"**                         | **0.002**      | (float) Only consider particles with a larger scattering angle than this for the fit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| **"acceptance_bound_high"**                        | **0.01**       | (float) Only consider particles with a smaller scattering angle than this for the fit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| **"resolution_smearing_active"**                   | **true**       | (bool) consider resolution effects, should always be **true**. For details, see Stefan Pflügers PhD thesis.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| **"inelastic_background_model_active"**            | **true**       | (bool) should always be **true**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| **"constant_background_source_model_active"**      | **true**       | (bool) should always be **true**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

### free_parameter_names

The human-readable names of the parameters that are to be fitted. This is mostly for convenience, as the names are used in the output from Minuit. The list can even remain empty.

## offset_trafo_matrix.json

An offset in the IP postition results in a shift/translation of the entire acceptance.

This is calculated with this 2x2 matrix (rotation) and 2x1 vector (translation).

## vertex_fitconfig.json

After the first reconstruction run (when no cuts have been applied yet), the reconstructed and back-propagetd tracks result in a distribution of interaction points. This distribution is fitted with a 2D Gaussian, of which the mean is the IP position. The parameters for this gauss fit are in this file.